# Быстрый старт
1. Откройте Android Studio.
2. В диалоговом окне «File» → «New» выберите «Import Project».
3. В диалоговом окне выберите папку sdk-android.
4. Подождите, пока проект загрузится.
5. В «Build Variants» выберите «stage» или «release».

## Требования

```gradle
defaultConfig {
    minSdkVersion 21
}
```


## Интеграция через .aar модуль
- Для установки .aar модуля необходимо открыть настройки модуля `Open Module Settings`.
- В открывшемся окне следует выбрать вкладку `Modules` и нажать на кнопку `+`
- В открывшемся окне нужно указать опцию  `Import .JAR/.AAR Package` и нажать на кнопку `Next`
- На этом экране необходимо указать путь к файлу  `.aar ` и имя модуля, после чего нажать на кнопку  `Finish`

Далее в зависимостях модуля, либо в пакете app в build.gradle следует иvпортировать sdk.

 ```
 implementation project(':wallet-debug')
 ```
Так же для корректной работы SDK необходимо добавить следующие зависимости: 

```
implementation "org.jetbrains.kotlin:kotlin-stdlib:$kotlin_version"
implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-core:1.5.1'
implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-android:1.5.1'
 
implementation 'com.squareup.retrofit2:retrofit:2.9.0'
implementation 'com.squareup.retrofit2:converter-gson:2.9.0'
implementation 'com.google.code.gson:gson:2.8.7'
implementation("com.squareup.okhttp3:logging-interceptor:4.9.1")
 
implementation("org.bouncycastle:bcprov-jdk15on:1.65")
implementation("org.bouncycastle:bcpkix-jdk15on:1.65")
```

Импортирование интерфейсного модуля Rx
```
implementation project(':wallet-debug-rx')
```

Зависимости
```
implementation group: 'io.reactivex.rxjava2', name: 'rxjava', version: '2.2.21'
implementation group: 'io.reactivex.rxjava2', name: 'rxandroid', version: '2.1.1'
 
implementation("com.squareup.okhttp3:okhttp:4.9.1")
api("com.squareup.okhttp3:logging-interceptor:4.9.1")
 
implementation("org.bouncycastle:bcprov-jdk15on:1.65")
implementation("org.bouncycastle:bcpkix-jdk15on:1.64")
```

# Сценарии использования SDK KD Pay

### Инициализация sdk
Для инициализации sdk необходимо создать экземпляр класса Wallet, либо WalletRx если используется технология RxJava. Где первый аргумент это context из Android SDK.
```
Wallet(context)
```

### Авторизация пользователя в системе KD Pay
Авторизация пользователя проходит в два этапа, для этого необходимо запросить у пользователя номер телефона (обязательное поле, на этот номер будет создан кошелёк), дополнительный номер телефона (необязательное), имя (необязательное), идентификатор устройства (если не передать, СДК попытается подставить автоматически) и идентификатор карты лояльности (необязательный). После чего указанные данные передаются в метод `login(phone, basePhone, name, uid, loyaltyId)`. Сервер в ответ на запрос посылает на номер пользователя шестизначный код, который вместе с `fcm` токеном нужно передать в метод `confirmCode(code, fcmToken)`. При успешном ответе от сервера sdk сохраняет в кеше необходимые данные (публичный ключ сервера, идентификаторы сессии и пользователя). После чего пользователь считается авторизованным 

```
fun login(phone: String, userBasePhone: String?, name: String?, uid: String?, loyaltyId: String?) {  
    lifecycleScope.launch {
        try {
            wallet.login(phone, userBasePhone, name, uid, loyaltyId)
        } catch(e: Exception) {
            Log.d(e)
        }
    }
}
 
fun confirm(smsCode: String, fcmToken: String) {  
    lifecycleScope.launch {  
        try {
            wallet.confirmCode(smsCode, fcmToken)
        } catch(e: Exception) {
            Log.d(e)
        }  
    }
}
```

### Создание кошелька
Для создания кошелька используется метод `createAccount()`. Для этого пользователь должен быть авторизован в системе KD Pay. Создание аккаунта занимает некоторое время и может быть дольше 30 секунд.

### Получение аккаунта пользователя
Получение аккаунта осуществляется с помощью метода `getAccount(cached)`. Для успешного получения состояния кошелька пользователь должен быть авторизован. Если клиент не авторизован в системе метод выбрасывает исключение. При отсутствии аккаунта в ответе поле `walletAccountState` будет иметь значение `NONE`.
```
fun getAccount() {
    lifecycleScope.launch {  
        val result = try {
            wallet.getAccount(false)
        } catch(e: Exception) {
            if(e is ErrorMessage.Client.NotAuthorized) {
                processNotAuthorized()
            }
            Log.d(e)
            null
        }
 
        if(result?.walletAccountState == WalletAccountState.NONE) {
            processAccountNotExists()
        }
 
        if(result?.walletAccountState == WalletAccountState.READY) {
            processSucess(result)
        }
       
    }
}
```

### Привязка банка к кошельку
Для того чтобы привязать к кошельку пользователя банк, необходимо получить список банков с помощью метода `getBanks()`. Для того чтобы использовать метод пользователь должен быть авторизован и у пользователя должен быть создан аккаунт. В противном случае метод вызовет исключение. Далее из списка полученных банков пользователь выбирает необходимый. После чего на сервер отправляется запрос на привязку банка с помощью метода `addNewBank(bankId)`. Если сервер ответил успехом, то пользователю предлагается перейти в мобильное приложение банка, и завершить процесс привязки банка.

```
fun selectBanksExample() {
    lifecycleScope.launch {
        val banks = try {    
            wallet.getBanks()
        } catch(e: Exception) {
            Log.d(e)
            null
        }
 
        banks?.let {
            showBanksList(banks = it, onBankSelected = { bankId ->
                try {      
                    wallet.addNewBank(bankId)
                } catch (e: Exception) {
                    Log.d(e)
                    showBankBindingError(e)
                }
             
        })
    }
}
```

### Проверка статуса привязки банка к аккаунту пользователя
Так как привязка банка осуществляется пользователем в стороннем мобильном приложении, то при вызове метода `addNewBank` не возвращается результат привязки банка. Для того чтобы проверить статус нужно запросить аккаунт пользователя с помощью метода `getAccount`. Ориентируясь на список привязанных банков и id банка, который привязывается к аккаунту можно понять в каком статусе находится привязка банка. Если банк присутствует списке привязанных банков, но поле `isLinked` у банка равно `false` - это значит что банк в процессе привязки к кошельку. В случае если поле равно `true`, значит процесс привязки банка успешен. В случае если в списке банков нет искомого, то это означает что произошла ошибка при привязке банка.

```
fun checkBindingStatus(cachedBankId: Int) {
    lifecycleScope.launch {
        val result = try {    
            wallet.getAccount(false)
        } catch(e: Exception) {
            Log.d(e)
            null
        }
 
       result?.let {
            val boundBank = result.walletAccount.banks.firstOrNull { it.id == cachedBankId }
            boundBank?.let {
                if(it.isLinked == true) showSuccessPopup() else showPendingPopup()
            } ?: showErrorPopup()          
        }
    }
}
```

### Установить банк по умолчанию
После привязки банка он становится банком по умолчанию. Для того чтобы изменить банк по умолчанию следует воспользоваться методом `setDefaultBank`. Для того чтобы использовать метод пользователь должен быть авторизован и у пользователя должен быть создан аккаунт, а так же привязан как минимум один банк. Для начала следует получить данные аккаунта методом `getAccount`, предложить пользователю выбрать из списка привязанных банков тот, который он хочет сделать основным. Далее передать `id` этого банка в метод `setDefaultBank(bankId)`. В результате чего в случае успеха метод вернет измененный и актуальный список привязанных банков.

```
fun setDefaultBank() {
    lifecycleScope.launch {
        val result = try {
               wallet.getAccount(false)
        } catch(e: Exception) {
            Log.d(e)
            null
        }
 
       result?.let {
            val boundBanks = result.walletAccount.banks
            showSelectDefaultBankDialog(boundBanks = boundBanks, onBankSelected = { selectedBankId: Int ->
                val modifiedBanks = wallet.setDefaultBank(selectedBankId)
                setNewBanks(modifiedBanks)
            })     
        }
    }
}
```

### Генерация qr кода
Для быстрого создания строки, кодируемой в qr-код, достаточно использовать метод `generateQrString(loyaltyId: String)`.
Метод не требует наличия интернета, если есть предзагруженные otp-коды.
(Otp-коды нужны также для генерации строки и SDK их самостоятельно (без действий на стороне МП) запрашивает на бэке "в фоне", когда есть интернет).
Есть возможность "попросить" SDK в явном виде получить новую пачку otp-кодов для генерации QR-кода, метод
`requestOtpCode(amount)`. Для использования методов пользователь должен быть предварительно авторизован и иметь аккаунт в системе.
```
fun preloadOtp() {
    lifecycleScope.launch {
        try {
            if(!wallet.haveOtpCode()) wallet.requestOtpCode(OTP_CODE_AMOUT)
        } catch(e: Exception) {
            Log.d(e)
        }
    }
}
 
fun generateQrString(loyaltyId: String) {
    lifecycleScope.launch {
        val qrString = try {
            wallet.generateQrString(loyaltyId)
        } catch(e: Exception) {
            Log.d(e)   
            null
        }
         
        qrString?.let { renderQrCode(it) }
    }
}
```

### Получение формы
Для платежного сервиса в сценариях необходимы формы для получения информации о пользователе. Формы динамические, то есть содержимое (состав полей) меняется в зависимости от контекста (сценария). Например, для привязывания счета необходимо заполнить форму упрощенной идентификации.
Получение формы происходит через метод `getFormFields(type: String, formId: Int?, formStatus: FormStatus?)`. Если запрос формы произойдет без `formId`, то сервер пришлет чистую форму.
Если запрос происходит с `formId`, то SDK отправит 2 запроса на сервер:  `/form/fields` и `/request`. Первый запрос получит форму, второй получит статус валидации для полей. SDK соединит полученные результаты и вернет форму с провалидированными полями.

*Примечание: количество полей и их состав сервер может поменять на своей стороне, форма является динамической.*

```
fun getFormFields(type: String, formId: Int?, formStatus: FormStatus) {  
    lifecycleScope.launch {
        try {
            wallet.getFormFields(type, formId, formStatus)
        } catch(e: Exception) {
            Log.d(e)
        }
    }
}
```

### Валидация полей формы
Для валидации полей используется метод `sendFormDraft(type: String, formId: Int?, version: Int?, draftFields: Map<Int, String>)`. Первый запрос на валидацию всегда будет происходить без `formId` и `version`. Актуальные значения `formId` и `version` вернутся при первой и последующей валидации. Валидировать необходимо все заполненные поля.

*Примечание: сервер сохраняет в следующем драфте поля "вместо" предыдущих. То есть если в первой версии драфта МП отправило заполненное поле 1, а потом не прислало это поле или прислало пустое, то в этой версии драфта поле не будет сохранено на сервере.*

При `sendFormDraft(type: String, formId: Int?, version: Int?, draftFields: Map<Int, String>)` SDK уберет пустые поля из запроса, чтобы не заваливать пользователя ошибками на пустых полях.

```
fun sendFormDraft(type: String, formId: Int?, version: Int?, draftFields: Map<Int, String>) {  
    lifecycleScope.launch {
        try {
            wallet.sendFormDraft(type, formId, version, draftFields)
        } catch(e: Exception) {
            Log.d(e)
        }
    }
}
```


### Отправка формы на проверку
Для валидации полей используется метод `sendFormCommit(type: String, formId: Int?, version: Int?, draftFields: Map<Int, String>)`. Первый запрос на `commit` может происходить без `formId` и `version`. Актуальные значения `formId` и `version` вернутся при первом и последующем `commit`. Отправлять необходимо все поля.

При `sendFormCommit(type: String, formId: Int?, version: Int?, draftFields: Map<Int, String>)` сервер отправит **все** поля, даже пустые, чтобы уведомить пользователя о незаполненных полях.

```
fun sendFormDraft(type: String, formId: Int?, version: Int?, draftFields: Map<Int, String>) {  
    lifecycleScope.launch {
        try {
            wallet.sendFormDraft(type, formId, version, draftFields)
        } catch(e: Exception) {
            Log.d(e)
        }
    }
}
```





# Методы

##### Метод для проверки состояния сервиса.
`ping()` 

##### Метод устанавливает идентификатор магазина.
`configure(buyerId: String)`

##### Метод возвращает идентификатор пользователя, если имеется.
`getUserId(): Int`

**Возвращает**
| Тип      | Опциональный | Описание |
| ----------- | ----------- | ----------- |
| UserInfo      | Нет       | Возвращает userId пользователя, если такой имеется |


##### Проверка доступа к кошелькам.
`getUserExperiment(phone: String, applicationVersion: String, deviceId: String?, loyaltyId: String): UserExperiments`

**Параметры**
| Имя      | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| phone| String| нет | Телефон указанный пользователем |
| applicationVersion | String| нет | Версия приложения |
| deviceId | String| да | Идентификатор пользователя в системе.  Если не указан используется 64-битное число (выраженное в виде шестнадцатеричной строки), уникальное для каждой комбинации ключа подписи приложения, пользователя и устройства.  |
| loyaltyId | String| нет | номер карты лояльности |

**Возвращает**
| Тип      | Опциональный | Описание |
| ----------- | ----------- | ----------- |
| UserExperiments      | Нет       | Вернет значение разрешены кошельки или нет для данного пользователя в зависимости от параметра BASE_FLOW|

##### Проверяет авторизован ли пользователь в системе по таким признакам как наличие в кеше идентификатора сессии и пользователя. А так же наличию публичного ключа сервера.
`isAuthorized(): Boolean`
**Возвращает**

| Тип      | Опциональный | Описание |
| ----------- | ----------- | ----------- |
| Boolean| Нет| true - пользователь авторизован, false - не авторизован (Нет идентификатора сессии, пользователя, либо публичного ключа сервера в кеше SDK)|


##### Первый шаг авторизации пользователя в системе KD Pay. Служит для запроса смс кода на указанный в параметрах модуль.
`login(userPhone: String, userBasePhone: String?, userName: String, uid: String?, loyaltyId: String?): Int`
**Параметры**

| Имя      | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| userPhone| String| нет | Телефон указанный пользователем |
| userBasePhone | String| да | Телефон пользователя в основном приложении |
| userName| String| да | Имя пользователя |
| uid| String| да | Идентификатор пользователя в системе.  Если не указан используется 64-битное число (выраженное в виде шестнадцатеричной строки), уникальное для каждой комбинации ключа подписи приложения, пользователя и устройства.  |
| loyaltyId | String| да | номер карты лояльности |

**Возвращает**
| Тип      | Опциональный | Описание |
| ----------- | ----------- | ----------- |
| Int| Нет| Идентификатор пользователя|

**Исключения**
| Тип      |  Описание |
| ----------- |  ----------- |
| ErrorMessage.Undefined("No user id") | не получен идентификатор пользователя от сервера|


##### Второй шаг авторизации пользователя в системе KD Pay. Служит для подтверждения телефона пользователя и завершения авторизации.
`confirmCode(code: String, fcmToken: String)`
**Параметры**

| Имя      | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| code| String| нет | Смс код полученный на указанный в методе login номер телефона |
| fcmToken| String| нет | Токен Firebase Messaging Service [подробнее](https://firebase.google.com/docs/cloud-messaging/android/client). |


**Исключения**
| Тип      |  Описание |
| ----------- |  ----------- |
| ErrorMessage.Client.BadConfirmCode() | Cтрока с смс кодом переданная в метод не корректна.|
| ErrorMessage.Client.Authorization() | userId не существует в кеше SDK. |
| ErrorMessage.Client.NotAuthorized() | нет сессии или она устарела|


##### Метод формирует строку, которую впоследствии можно закодировать в qr код для оплаты на кассе. При отсутствии закерованных otp кодов, метод берет себя работу по их получению и кешированию.
`generateQrString(loyaltyId: String): String`
**Параметры**

| Имя      | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| loyaltyId| String| нет | Идентификатор лояльности во внешней системе |


**Возвращает**
| Тип      | Опциональный | Описание |
| ----------- | ----------- | ----------- |
| String | Нет| Строка для кодирования в Qr код|

**Исключения**
| Тип      |  Описание |
| ----------- |  ----------- |
| ErrorMessage.Client.Serialization("No loyalty id") | loyaltyId пуст |
| ErrorMessage.Client.NoOtpCode("No free OTP codes") | нет свободных otp кодов |
| ErrorMessage.Client.Authorization | userId или публичный ключ сервера не существует в кеше SDK |


##### Запрос на создание аккаунта в системе KD Pay.
`createAccount(): WalletAccountResult`


**Возвращает**
| Тип      | Опциональный | Описание |
| ----------- | ----------- | ----------- |
| WalletAccountResult | Нет| Ответ содержащий аккаунт пользователя в системе и текущий статус аккаунта. |

**Исключения**
| Тип      |  Описание |
| ----------- |  ----------- |
| ErrorMessage.Client.NotAuthorized()| Сессия отсутствует или устарела |
| ErrorMessage.Client.Authorization() | Отсутствует идентификатор пользователя в системе. Необходима авторизация.  |


##### Получение аккаунта пользователя в системе KD Pay.
`getAccount(cached): WalletAccountResult`
**Параметры**

| Имя      | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| cached| Boolean| нет | Флаг для определения откуда брать данные аккаунта. true - из кеша, false - из сервера с последующим кешированием.|


**Возвращает**
| Тип      | Опциональный | Описание |
| ----------- | ----------- | ----------- |
| WalletAccountResult | Нет| Ответ содержащий аккаунт пользователя в системе и текущий статус аккаунта |

**Исключения**
| Тип      |  Описание |
| ----------- |  ----------- |
| ErrorMessage.Client.NotAuthorized("Not authorized") | Пользователь не авторизован в системе KD Pay. Либо устарела сессия. |

##### Получение списка банков, которые можно привязать к кошельку.
`getBanks(): List<Bank>`
**Параметры**


**Возвращает**
| Тип      | Опциональный | Описание |
| ----------- | ----------- | ----------- |
| List<Bank> | Нет| Cписок банков, которые можно привязать к кошельку. |

**Исключения**
| Тип      |  Описание |
| ----------- |  ----------- |
| ErrorMessage.Client.NotAuthorized() | Сессия отсутствует или устарела |
| ErrorMessage.Client.Authorization() | Отсутствует идентификатор пользователя в системе. Необходима авторизация.  |
| ErrorMessage.Client.NoAccount() | Нет аккаунта пользователя |


##### Метод для установки банка по умолчанию. Выбирается из списка привязанных банков.
`addNewBank(bankId: Int)`
**Параметры**

| Имя      | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| bankId| Int| нет |Идентификатор банка в системе KD Pay, выбранных из списка банков получаемых с помощью метода getBanks()|

**Исключения**
| Тип      |  Описание |
| ----------- |  ----------- |
| ErrorMessage.Client.NotAuthorized() | Сессия отсутствует или устарела |
| ErrorMessage.Client.Authorization() | Отсутствует идентификатор пользователя в системе. Необходима авторизация.  |
| ErrorMessage.Client.NoAccount() | Нет аккаунта пользователя |


##### Метод для установки банка по умолчанию. Выбирается из списка привязанных банков.
`setDefaultBank(bankId: Int): List<Bank>`
**Параметры**

| Имя      | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| bankId| Int| нет | Идентификатор банка в системе KD Pay, выбранных из списка привязанных банков |


**Возвращает**
| Тип      | Опциональный | Описание |
| ----------- | ----------- | ----------- |
| List<Bank> | Нет| Список привязанных банков, с измененным банком по умолчанию. |

**Исключения**
| Тип      |  Описание |
| ----------- |  ----------- |
| ErrorMessage.Client.NotAuthorized() | Сессия отсутствует или устарела |
| ErrorMessage.Client.Authorization() | Отсутствует идентификатор пользователя в системе. Необходима авторизация.  |
| ErrorMessage.Client.NoAccount() | Нет аккаунта пользователя |

##### Метод для проверки наличия сохраненных otp кодов в кеше sdk.
`haveOtpCode(): Boolean`

**Возвращает**
| Тип      | Опциональный | Описание |
| ----------- | ----------- | ----------- |
| Boolean | Нет| true - есть как минимум один сохраненный otp код. false - не сохраненных otp кодов. |


##### Метод для получение otp кодов с сервера с последующим сохранением в кеш sdk.
`requestOtpCodes(amount: Int)`
**Параметры**

| Имя      | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| amount| Int| нет | Количество запрашиваемых otp кодов. |

**Исключения**
| Тип      |  Описание |
| ----------- |  ----------- |
| ErrorMessage.Client.NotAuthorized() | Сессия отсутствует или устарела |
| ErrorMessage.Client.Authorization() | Отсутствует идентификатор пользователя в системе. Необходима авторизация.  |
| ErrorMessage.Client.NoAccount() | Нет аккаунта пользователя |
| ErrorMessage.Server.BadServerResponse("No code") | Ни один код не был получен от сервера. |
| ErrorMessage.Server.BadServerResponse("No expiration time for code") | Нет срока окончания действия кода |
| ErrorMessage.Client.NoBuyerId() | Не установлен buyerId. Смотреть метод `configure(buyerId)` |

##### Метод для получения количества оставшихся otp кодов
`remainingOtpCodes(): Int`

**Возвращает**
| Тип      | Опциональный | Описание |
| ----------- | ----------- | ----------- |
| Int | Нет| количество оставшихся otp кодов |

##### Запрашивает  указанное в параметре количество otp кодов, если их оставшееся количество валидных меньше 6
`requestOtpCodesIfRequired(amount: Int)`
**Параметры**

| Имя      | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| amount| Int| нет | Количество запрашиваемых otp кодов. |

##### Метод получения формы упрощенной идентификации
`getFormFields(type: String, formId: Int?, formStatus: FormStatus?): Form`
**Параметры**

| Имя      | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| type| String| нет | Тип формы, которая задает определенный набор полей. |
| formId| Int| да | Идентификатор последнего актуального заполнения. |
| formStatus| FormStatus| да | Статус последнего актуального заполнения. |

**Возвращает**
| Тип      | Опциональный | Описание |
| ----------- | ----------- | ----------- |
| Form | Нет| Форма для упрощенной идентификации пользователя |

**Исключения**
| Тип      |  Описание |
| ----------- |  ----------- |
| ErrorMessage.Client.NotAuthorized() | Сессия отсутствует или устарела |
| ErrorMessage.Client.Authorization() | Отсутствует идентификатор пользователя в системе. Необходима авторизация.  |


##### Метод для отправки черновика формы
`sendFormDraft(type: String, formId: Int?, version: Int?, draftFields: Map<Int, String>): FormDraft`
**Параметры**

| Имя      | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| type| String| нет | Тип формы, которая задает определенный набор полей. |
| formId| Int| да | Идентификатор последнего актуального заполнения. |
| version| Int | да | Версия последнего актуального заполнения. |
| draftFields| Map<Int, String> | нет | Идентификатор валидируемого поля и его значение. |

**Возвращает**
| Тип      | Опциональный | Описание |
| ----------- | ----------- | ----------- |
| FormDraft | Нет| Актуальная информация формы и список невалидных полей |

**Исключения**
| Тип      |  Описание |
| ----------- |  ----------- |
| ErrorMessage.Client.NotAuthorized() | Сессия отсутствует или устарела |
| ErrorMessage.Client.Authorization() | Отсутствует идентификатор пользователя в системе. Необходима авторизация.  |
| ErrorMessage.Client.NoAccount() | Нет аккаунта пользователя |


##### Метод для коммита формы
`sendFormCommit(type: String, formId: Int?, version: Int?, draftFields: Map<Int, String>): FormDraft`
**Параметры**

| Имя      | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| type| String| нет | Тип формы, которая задает определенный набор полей. |
| formId| Int| да | Идентификатор последнего актуального заполнения. |
| version| Int | да | Версия последнего актуального заполнения. |
| draftFields| Map<Int, String> | нет | Идентификатор валидируемого поля и его значение. |

**Возвращает**
| Тип      | Опциональный | Описание |
| ----------- | ----------- | ----------- |
| FormDraft | Нет| Актуальная информация формы и список невалидных полей |

**Исключения**
| Тип      |  Описание |
| ----------- |  ----------- |
| ErrorMessage.Client.NotAuthorized() | Сессия отсутствует или устарела |
| ErrorMessage.Client.Authorization() | Отсутствует идентификатор пользователя в системе. Необходима авторизация.  |
| ErrorMessage.Client.NoAccount() | Нет аккаунта пользователя |


##### Метод проверки версии бибоиотеки
`checkLibraryVersion(cacheInterval: Long = 0L): VersionResult`
**Параметры**

| Имя      | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| cacheInterval| Long| да | Интервал проверки кэша в секундах. Если не выставлен интервал, то кеш не используется. |

**Возвращает**
| Тип      | Опциональный | Описание |
| ----------- | ----------- | ----------- |
| VersionResult | нет| Возвращает результат проверки. При любой ошибке возвращает VersionResult.UNKNOWN |


##### Полная очистка кеша sdk. Удаляются идентификаторы сессии, пользователя, публичный ключ сервера, отп коды и номер телефона пользователя.
`logout()`


# Структура данных

#### `WalletAccountResult`
| Имя свойства | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| walletAccountState | WalletAccountState | нет | Описывает состояние аккаунта |
| walletAccount | WalletAccount | да | Модель данных кошелька |


#### `WalletAccountState` enum
| Имя | Описание |
| ----------- | --------|
| NONE |  Нет аккаунта пользователя |
| PENDING | Аккаунта в процессе создания |
| READY | Аккаунт существует и готов к работе |
| BANNED | Аккаунт забанен |


#### `WalletAccount`
| Имя свойства | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| id | Int | нет | Идентификатор аккаунта  |
| balance | BigDecimal | нет ( 0 по умолчанию) | Баланс пользователя |
| currency | String | нет | Строковый код валюты |
| status | WalletStatus | нет (Undefined по умолчанию) | Состояние кошелька |
| banks | List<Bank> | нет  | 	Список привязанных к кошельку банков |
| forms | List<FormAccount> | нет  | Список форм для упрощенной идентификации |


#### `WalletStatus ` enum
| Имя | Описание |
| ----------- | --------|
| Undefined | Неизвестное состояние кошелька |
| Active | Кошелек активен и готов к работе |
| Blocked | Кошелек заблокирован |
| Closed | Кошелек закрыт |


#### `Bank`
| Имя свойства | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| id | Int | нет | Идентификатор банка в системе  |
| name | String | нет | Имя банка в системе  |
| imageLink | String | да | Ссылка на логотип банка  |
| isLinked | Boolean | нет (false по умолчанию) | Состояние привязки банка. Если банк присутствует в списке, но его статус isLinked == false, это означает что банк в процессе привязки.   |
| isDefault | Boolean | нет (false по умолчанию) | Банк выбран основным. С счета этого банка будут сниматься средства при платежах кошельком.  |


#### `FormAccount`
| Имя свойства | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| type | String | нет | Тип формы, задает конкретный набор полей  |
| status | FormStatus | да | Статус формы последнего актуального заполнения. Пустое поле или нет поля – пользователь не заполнял форму |
| formId | Int | да | Идентификатор формы последнего актуального заполнения |
| isRequired | Boolean | нет | Необходимо ли пользователю заполнить/дозаполнить форму |
| description | String | нет | Текст, который можно показать пользователю |
| version | Int | да | Версия формы последнего актуального заполнения |

#### `FormStatus` enum
| Имя | Значение |Описание|
| ----------- | ----------- | ----------- |
| Draft | draft | Форма заполнялась, но не была отправлена |
| Commit | commit | Форма была отправлена, но не запушена |
| Processing | processing | Форма в процессе обработки |
| Invalid | invalid | Форма заполнена неверно |
| Success | success | Форма успешно заполнена |
| NotExists | not_exists | Форма отсутствует |
| Unknown | unknown | Форма неизвестна |


#### `Form`
| Имя свойства | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| id | Int | да | Идентификатор формы. Может его не быть, если форму пользователь получает впервые |
| version | FormStatus | нет | Статус формы последнего актуального заполнения. |
| pageCount | Int | нет | Количество страниц |
| title | String | да | Заголовок формы |
| pages | Map<Int, FormPage> | нет | Словарь страниц сформированный по `FormPage.id` идентификаторам |
| visibilityChecks | List<VisibilityCheck> | нет | Список проверки видимости |


#### `FormPage`
| Имя свойства | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| id | Int | нет | Идентификатор страницы |
| number | Int | нет | Номер страницы |
| name | String | да | 	Имя страницы |
| description | String | да | Описание страницы |
| groups | Map<Int, FormGroup> | нет | Словарь групп сформированный по `FormGroup.id` |
| submitButtonText | String | да | Текст на кнопке отправки страницы формы |

#### `VisibilityCheck`
| Имя свойства | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| dependantFieldId | Int | нет | Идентификатор зависимого поля |
| parentFieldId | Int | нет | Идентификатор родительского поля. У группы зависимых элементов родительский идентификатор совпадает. |
| operation | VisibilityCheckOperation | да | Операция проверки видимости |
| value | String | да | Значение проверки видимости |


#### `VisibilityCheckOperation ` enum
| Имя | Описание|
| ----------- | ----------- |
| Equals | Проверка на равенство. `check = { FormField, String-> field.value == value }` |
| Unknown | Всегда возвращает true. `check = { _, _ -> true } `|


#### `FormGroup`
| Имя свойства | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| id | Int | нет | Идентификатор группы |
| number | Int | нет | Номер группы |
| pageId | Int | нет | Идентификатор страницы |
| name | String | да | Имя группы |
| description | String | да | Описание группы |
| fields | Map<Int, FormField> | нет | Словарь полей сформированный по `FormField.id` |


#### sealed `FormField`
| Имя свойства | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| id | Int | нет | Идентификатор поля |
| groupId | Int | да | Идентификатор группы |
| isRequired | Boolean | нет | Требуется ли для заполнения По умолчанию всегда true |
| isVisible | Boolean | нет | Видимость поля По умолчанию всегда  true |
| value | String | да | Значение поля |
| initalValue | String | да | Изначальное значение поля |
| validationResult | ValidationResult | да | Результат валидации поля |

#### `RadioGroup` : FormField
| Имя свойства | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| id | Int | нет | Идентификатор поля |
| groupId | Int | да | Идентификатор группы |
| isRequired | Boolean | нет | 	Требуется ли для заполнения По умолчанию всегда true |
| choices | Map<Int, RadioButton> | нет | 	Словарь переключателей сформированный по `RadioButton.id` |
| placeholder | String | да | Заполнитель |

#### `RadioButton`
| Имя свойства | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| id | Int | нет | Идентификатор кнопки переключателя |
| radioGoupId | Int | нет | Идентификатор группы переключателя |
| placeholder | String | нет | Описание кнопки переключателя |
| value | String | нет | Значение, уходящее в группу переключателя |
| selected | String | нет | Состояние переключателя. По умолчанию false. |

#### `EditText` : FormField
| Имя свойства | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| id | Int | нет | Идентификатор поля |
| groupId | Int | да | Идентификатор группы |
| isRequired | Boolean | нет | Требуется ли для заполнения. По умолчанию всегда true |
| placeholder | String | да | Заполнитель |
| inputType | EditTextInputType | нет | Тип поля |
| mask | String | да | Маская для поля |
| minLength | Int | да | Минимальное количество символов |
| maxLength | Int | да | Максимальное количество символов |
| hideSymbols | Boolean | нет | Скрывать символы. По умолчанию false |

#### `EditTextInputType  ` enum
| Имя | Описание|
| ----------- | ----------- |
| Text | Текстовое поле |
| Date | Поле даты |
| Number | Числовое поле |


#### `ValidationResult`
| Имя свойства | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| isValid | Boolean | нет | Состояние валидности поля  |
| isRequired | Boolean | нет | Требуется ли для заполнения  |
| errorMessage | String | да | Сообщение об ошибке  |


#### `FormDraft`
| Имя свойства | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| requestId | Int | нет | Актуальный идентификатор формы |
| status | StatusDraft | нет | Статус драфта формы |
| version | Int | нет | Актуальная версия формы |
| details | List<Draft> | да | Список невалидных полей и их описание |

#### `Draft`
| Имя свойства | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| fieldId | Int | нет | Идентификатор поля |
| errorCode | Stirng | нет | Код ошибки валидации формы |
| description | Stirng | нет | Описание |
| userMessage | Stirng | нет | Описание ошибки для пользователя |


#### `StatusDraft   ` enum
| Имя | Описание|
| ----------- | ----------- |
| Error | В форме имеются поля, не прошедшие валидацию |
| Ok | Все поля в черновике валидны |



#### sealed `UserExperiments`
| Имя свойства |Описание|
| ----------- |--------|
| object `Normal` | Кошельки доступны |
| NotAvailable | Кошельки недоступны |

#### `NotAvailable`: UserExperiments
| Имя свойства | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| hasQrCodes | Boolean | нет | Имеется ли Qr-код |


#### sealed `UserInfo`
| Имя свойства |Описание|
| ----------- |--------|
| Exists | Возвращается, если пользователь авторизован |
| object `NotExists` | Возвращается, если пользователь `не` авторизован |

#### `Exists `: UserInfo
| Имя свойства | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| userId | Int | нет | Идентификатор пользователя |


#### sealed `VersionResult`
| Имя свойства |Описание|
| ----------- |--------|
| object `ACTUAL` | Версия библиотеки актуальная, обновления не требуются. |
| object `MINOR` | Доступно небольшое обновление. |
| MAJOR | Доступно обновление. |
| CRITICAL | Требуется обновление, использование кошельков невозможно. |
| object `UNKNOWN` | Получено что-то иное, использование кошельков невозможно. |

#### `MAJOR`: VersionResult
| Имя свойства | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| actualVersion | String | нет | Текущая актуальная версия библиотеки |
| actualDescription | String | да | Описание актуальной версии |
| currentDescription | String | да | Описание текущей версии |
| storeLink | String | да | Ссылка на магазин для обновления версии мобильного приложения |

#### `CRITICAL`: VersionResult
| Имя свойства | Тип | Опциональный |Описание|
| ----------- | ----------- | ----------- |--------|
| actualVersion | String | нет | Текущая актуальная версия библиотеки |
| actualDescription | String | да | Описание актуальной версии |
| currentDescription | String | да | Описание текущей версии |
| storeLink | String | да | Ссылка на магазин для обновления версии мобильного приложения |

